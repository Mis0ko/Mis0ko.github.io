---
title: "11.Injection d'entité externe XML (XXE)"
category: "Serveur"
tag: "Web"
---
## CheckList en pratique


## Explication de la vulnérabilité  

L'injection d'entité externe XML **(XXE)** est une vulnérabilité qui permet à un attaquant d'interférer avec le traitement des données XML par une application.  
Cela permet souvent à un attaquant d'afficher des fichiers sur le système de fichiers du serveur d'applications et d'interagir avec tous les systèmes back-end ou externes auxquels l'application elle-même peut accéder.

Dans certains cas, une xxe peut permettre à un attaquant de compromettre un serveur en effectuant des SSRF.

## Comment surviennent les vulnérabilités XXE ?
Certaines applications utilisent du format XML pour faire transiter des données entre le navigateur et le serveur. Ces applications utilise des librairie standard ou une API pour traiter les données XML sur le serveur.

Les xxe surviennent car les specifications XML contiennent diverses fonctionnalités potentiellement dangereuses.


Faisons un bref rappel des notions autour de XML et des entités XML.

### Qu'est ce que XML?
XML (extensible markup langage) est un langage conçu pour stocker et transférer des données. Il utilise une structure arborescente de balises et de données.   
Les balises ne sont pas prédéfinis (on peut leur attribuer un nom qui correspond à la donnée).

### Que sont les entités XML?
Les entités XML sont un moyen de représenter un élément de données dans un document XML, au lieu d'utiliser les données elles-mêmes.
Par exemple, les entités `&lt;` et `&gt;` représentent les caractères `<` et `>`. Ce sont des métacaractères utilisés pour désigner les balises XML et doivent donc généralement être représentés à l'aide de leurs entités lorsqu'elles apparaissent dans les données.

### Qu’est-ce que la définition du type de document ?
La définition de type de document XML **(DTD)** contient des déclarations qui peuvent définir la structure d'un document XML, les types de valeurs de données qu'il peut contenir et d'autres éléments.

Le DTD est déclaré dans l'élément facultatif `DOCTYPE` au début du document XML. Le DTD peut être dans le document lui-même (interne) ou chargée depuis un autre endroit (externe) ou peut être un hybride des deux.

Un exemple de document XML :
```html
<?xml version="1.0"?>
<!DOCTYPE encyclopedie SYSTEM "encyclopedie.dtd">
<encyclopedie>...</encyclopedie>
```

Avec le DTD associé (encyclopedie.dtd):

```html
<?xml version="1.0"?>
<!ELEMENT encyclopedie     (personne*)>
<!ELEMENT personne  (nom,prenom,publication+)>
<!ATTLIST personne sexe (H | F) "H">
<!ELEMENT nom       (#PCDATA)>
<!ELEMENT prenom    (#PCDATA)>
<!ELEMENT publication (#PCDATA)>
```

### Que sont les entités XML personnalisées ?
XML permet de définir des entités personnalisées dans la DTD.  
Par exemple:
`<!DOCTYPE foo [ <!ENTITY myentity "my entity value" > ]>`

Cette définition signifie que toute utilisation de la référence d'entité `&myentity;` dans le document XML sera remplacé par la valeur définie : "ma valeur d'entité".

### Que sont les entités externes XML ?

Les entités externes XML sont un type d'entité personnalisée dont la définition se situe en dehors de la DTD où elles sont déclarées.

La déclaration d'une entité externe utilise le mot-clé `SYSTEM` et doit spécifier une URL à partir de laquelle la valeur de l'entité doit être chargée.  
Par exemple:
`<!DOCTYPE foo [ <!ENTITY ext SYSTEM "http://normal-website.com" > ]>`


L'URL peut utiliser le protocole `file://`, ainsi des entités externes peuvent être chargées à partir du fichier.  
Par exemple:
`<!DOCTYPE foo [ <!ENTITY ext SYSTEM "file:///path/to/file" > ]>`


## Quels sont les types d’attaques XXE ?

- `Exploitation de XXE pour récupérer des fichiers`, où une entité externe est définie contenant le contenu d'un fichier et renvoyée dans la réponse de l'application.
- `Exploiter XXE pour effectuer des attaques SSRF`, où une entité externe est définie en fonction d'une URL vers un système back-end.
- `Exploiter Blind-XXE pour exfiltre les données hors bande`, où les données sensibles sont transmises du serveur d'applications à un système contrôlé par l'attaquant.
- `Exploiter Blind-XXE pour récupérer des données via des messages d'erreur`, où l'attaquant peut déclencher un message d'erreur d'analyse contenant des données sensibles.

## Exploitation de XXE pour récupérer des fichiers
Pour effectuer une attaque par injection XXE qui récupère un fichier du système de fichiers du serveur, On peut modifier le XML soumis de 2 manières :
- Introduire (ou modifier) un élément `DOCTYPE` qui définit une entité externe contenant le chemin d'accès au fichier.
- Modifier une donnée dans le XML qui est renvoyé dans la réponse de l'application, pour utiliser l'entité externe définie.

Par exemple, supposons qu'une application d'achat vérifie le niveau des stocks d'un produit en soumettant le code XML suivant au serveur :
```html
<?xml version="1.0" encoding="UTF-8"?>
<stockCheck><productId>381</productId></stockCheck>
```

L'application n'effectue aucune défense particulière contre les attaques XXE, On peut donc exploiter la vulnérabilité XXE pour récupérer le fichier `/etc/passwd ` :

```html
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
<stockCheck><productId>&xxe;</productId></stockCheck>
```
> Penser à tester tous les champs d'un document xml pour une éventuelle xxe.

## Exploiter XXE pour effectuer des attaques SSRF
Outre la récupération de données sensibles, l'autre impact principal des attaques XXE est qu'elles peuvent être utilisées pour effectuer des `SSRF`.
Il s'agit d'une vulnérabilité dans laquelle l'application backend peut être amenée à effectuer des `requêtes HTTP` vers n'importe quelle URL à laquelle le serveur peut accéder.  

Pour **exploiter** une vulnérabilité XXE afin d'effectuer un `SSRF`, il faut définir une entité XML externe à l'aide de l'URL cible et utiliser <u>l'entité définie dans une valeur de données.</u>


Si on peut utiliser l'entité définie dans une valeur de donnée, et que celle-ci est renvoyé dans la réponse de la requête, alors on peut voir la réponse de l'URL fournit à l'entité et on a une intéraction bidirectionnel.

Dans le cas où on ne peut pas voir la réponse, on pourra seulement effectuer des attaques `Blind SSRF`.

> La différence par rapport à la partie précédente est qu'on va essayer de faire exécuter des requêtes (par exemples HTTP), à la machine plutôt que d'afficher un fichier local. On peut imaginer de faire une bruteforce sur les adresses IP privées classiques pour voir s'il existe une @IP qui réagit.


## Blind-XXE

Une Blind-XXE consiste en une vulnérabilité `XXE`, à la différence que l'application ne renvoie les valeurs d'aucune entité externe définie dans ses réponses et que la récupération directe des fichiers côté serveur n'est donc pas possible.


AAAAAAAA FAIRE PLUS TARD


## Trouver une surface d'attaque cachée pour l'injection XXE

### Attaques XInclude
### Attaques XXE par upload de fichiers
### Attaques XXE par modification de content-type


## Comment trouver et tester les vulnérabilités XXE

## Comment prévenir les vulnérabilités XXE



